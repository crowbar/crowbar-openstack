#!/bin/bash -x

source /root/.openrc #TODO: use environment variables

flavor="<%= @flavor %>"
image_tag="<%= @image_tag %>"
package="openstack-octavia-amphora-image-x86_64"

openstack flavor create --public --ram 1024 --disk 2 --vcpus 1 $flavor

image_id=$(openstack image list | grep $image_tag | head -n 1 | tr -d " " | cut -f 2 -d "|" )

if [ $image_id -z ]; then
        file=$(rpm -ql $package | grep qcow2 | head -n 1)
        image_id=$(openstack image create --disk-format qcow2 --container-format bare --file  $file $image_tag  | tr -d " " | grep "|id|" | cut -f 3 -d "|")
        openstack image set --tag $image_tag $image_id
else
        echo "Skipped image-list already exists"
fi
